<template>
  <div class="container">
    <div class="main">
      <backBtn></backBtn>
      <el-divider style="margin: 0 20px" direction="vertical"></el-divider>
      <el-button type="primary" v-debounce @click="handleConfirmSave">确 定</el-button>
      <el-button type="primary" v-debounce v-if="!isEdit" style="float: right" @click="handleExport">导 入</el-button>
      <el-table :data="tableData">
        <el-table-column type="index" v-if="!isEdit" width="50" label="序号"></el-table-column>
        <el-table-column prop="id" v-if="isEdit" label="ID" width="50"> </el-table-column>
        <el-table-column prop="name" class-name="table-column-left" label="任务名称" width="300">
          <template #default="scoped">
            <el-input v-model="scoped.row.name" maxlength="50" placeholder="请输入不超过50字的任务名称"></el-input>
          </template>
        </el-table-column>
        <el-table-column prop="type" label="需求" width="150">
          <template #default="scoped">
            <el-select v-model="scoped.row.demand_id" placeholder="请选择" :disabled="scoped.row.is_sys">
              <div v-if="scoped.$index == 0">
                <el-option v-for="item in newDemandLists_top" :key="item.id" :label="item.name" :value="item.id"> </el-option>
              </div>
              <div v-else>
                <el-option v-for="item in demandLists_last" :key="item.id" :label="item.name" :value="item.id"> </el-option>
              </div>
            </el-select>
          </template>
        </el-table-column>
        <el-table-column prop="type" label="类型" width="100">
          <template #default="scoped">
            <el-select v-model="scoped.row.type" placeholder="类型" :disabled="scoped.row.is_sys">
              <div v-if="scoped.$index == 0">
                <el-option v-for="item in TYPE_STATUS_DELETE_ALL" :key="item.value" :label="item.label" :value="item.value"> </el-option>
              </div>
              <div v-else>
                <el-option v-for="item in TYPE_STATUS_LAST" :key="item.value" :label="item.label" :value="item.value"> </el-option>
              </div>
            </el-select>
          </template>
        </el-table-column>

        <el-table-column prop="address" label="指派给" width="120">
          <template #default="scoped">
            <el-select :disabled="scoped.row.is_sys" v-model="scoped.row.staff_name" filterable placeholder="请选择">
              <div v-if="scoped.$index == 0">
                <el-option v-for="item in newEmployeeLists" :key="item.staff_no" :label="item.staff_name" :value="item.staff_name"> </el-option>
              </div>
              <div v-else>
                <el-option v-for="item in employeeLists_last" :key="item.staff_no" :label="item.staff_name" :value="item.staff_name"> </el-option>
              </div>
            </el-select>
          </template>
        </el-table-column>
        <el-table-column prop="address" label="起止时间" width="250">
          <template #default="scoped">
            <el-date-picker
              :disabled="scoped.row.is_sys"
              v-model="scoped.row.time"
              type="daterange"
              range-separator="至"
              start-placeholder="开始日期"
              end-placeholder="结束日期"
              value-format="YYYY-MM-DD"
            >
            </el-date-picker>
          </template>
        </el-table-column>
        <el-table-column prop="name" label="工时" width="90">
          <template #default="scoped">
            <el-input placeholder="工时" :disabled="scoped.row.is_sys" v-model.number="scoped.row.hours" maxlength="10"></el-input>
          </template>
        </el-table-column>
        <!-- <el-table-column prop="address" label="关联计划" width="150">
          <template #default="scoped">
            <el-select v-model="scoped.row.id" placeholder="请选择">
              <div v-if="scoped.$index == 0">
                <el-option v-for="item in planLists" :key="item.plan.id" :label="item.plan.name" :value="item.plan.id"> </el-option>
              </div>
              <div v-else>
                <el-option v-for="item in planLists_last" :key="item.plan.id" :label="item.plan.name" :value="item.plan.id"> </el-option>
              </div>
            </el-select>
          </template>
        </el-table-column> -->
        <el-table-column prop="type" label="优先级" width="100">
          <template #default="scoped">
            <el-select v-model="scoped.row.level" placeholder="等级" :disabled="scoped.row.is_sys">
              <div v-if="scoped.$index == 0">
                <el-option v-for="item in CASEPRIORITY" :key="item.value" :label="item.value" :value="item.id"> </el-option>
              </div>
              <div v-else>
                <el-option v-for="item in CASE_PRIORITY_LAST" :key="item.value" :label="item.value" :value="item.id"> </el-option>
              </div>
            </el-select>
          </template>
        </el-table-column>
        <el-table-column prop="remark" class-name="table-column-left" label="备注">
          <template #default="scoped">
            <el-input type="textarea" :autosize="{ minRows: 2, maxRows: 4 }" v-model="scoped.row.remark"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="120" v-if="!isEdit">
          <template #default="scoped">
            <el-icon class="action" @click="handlePlusTable(scoped.$index)">
              <CirclePlus />
            </el-icon>
            <el-divider direction="vertical"></el-divider>
            <el-icon
              class="action"
              :style="{ pointerEvents: scoped.$index === 0 ? 'none' : '', color: scoped.$index === 0 ? '#ccc' : '' }"
              :disable="scoped.$index !== 0"
              @click="handleRemoveTable(scoped.$index)"
            >
              <Remove />
            </el-icon>
          </template>
        </el-table-column>
      </el-table>
    </div>
    <!-- 导入 -->
    <div>
      <el-dialog title="快捷导入" style="flex-wrap: wrap" v-model="exportShow" width="30%">
        <div>
          <p style="margin-top: 0">1、下载模板</p>
          <span>
            下载任务模板，并按照规则填写内容
            <a href="https://file.vetscloud.com/taskTemplate.xlsx">下载模板</a>
          </span>
        </div>
        <div>
          <p>2、上传内容</p>
          <el-upload
            class="upload-demo"
            ref="fileList"
            drag
            action="alert"
            :auto-upload="false"
            multiple
            :before-upload="beforeAvatarUpload"
            :on-change="uploadChange"
            :limit="1"
          >
            <i class="el-icon-upload"></i>
            <div class="el-upload__text">将文件拖到此处，或<em>点击选择文件上传</em></div>
          </el-upload>
        </div>
        <div v-if="fileName">
          上传成功: <span style="color: #1f9f85">{{ fileName }}</span>
        </div>
        <template #footer>
          <span class="dialog-footer">
            <el-button @click="handleCancel">取 消</el-button>
            <el-button type="primary" v-debounce @click="handleExportData">提 交</el-button>
          </span>
        </template>
      </el-dialog>
    </div>
  </div>
</template>

<script lang="ts">
import { defineComponent, computed, ref, watch } from "vue";
import { getSession, readFile, TYPE_STATUS, PRIORITY } from "@/utils";
// import { useStore } from "@/store";
import { createTaskList, updateTask } from "@/api/request-modules/iteration";
import { getPlanLists } from "@/api/request-modules/plan";
import xlsx from "xlsx";
import { ResponseParams } from "@/types/response";
import useMessageTip from "@/composables/useMessageTip";
import { useRoute, useRouter } from "vue-router";
import useMixin from "../useMixin";
import { ElLoading } from "element-plus";
import { CirclePlus, Remove } from "@element-plus/icons";

export default defineComponent({
  components: { CirclePlus, Remove },

  setup() {
    const router = useRouter();
    const route = useRoute();
    const fileList = ref();
    const isEdit = ref(false);
    const rawTableData = {
      // 任务名称
      name: "",
      // 指派给
      staff_name: "",
      staff_no: "",
      // 类型
      type: "",
      demand_id: "",
      level: "",
      time: [],
      // // 开始时间
      // real_begin_time: "",
      // // 结束时间
      // real_end_time: "",
      // 工时
      hours: "",
      // 需求id
      iteration_id: "",
      // 备注
      remark: ""
    };

    const tableData = ref(
      Array(route.query.isEdit ? 1 : 3)
        .fill({})
        .map(() => {
          return { ...rawTableData };
        })
    );

    if (route.query.isEdit) {
      const userInfo = getSession("editTask", true) as any;
      isEdit.value = true;
      userInfo.forEach((item: Record<string, any>) => {
        item.time = [item.begin_time, item.end_time] as Array<string>;
        item.demand_id = item.demand_id ? item.demand_id : 0;
      });
      tableData.value = userInfo;
      // (tableData[0].time as Array<string>) = [userInfo.begin_time, userInfo.end_time] as Array<string>;
    } else {
      // 填充数据处理，将类型，指派给默认设置为同上
      tableData.value.forEach((v, index) => {
        if (index >= 1) {
          v.staff_no = "500";
          v.type = v.staff_name = "同上";
          v.level = "同上";
          v.demand_id = "同上";
        }
      });
    }
    const planLists = ref([]);

    const { tipMessage } = useMessageTip();
    const planLists_last = ref<Record<string, any>>([]);

    // 优先级
    const CASEPRIORITY = PRIORITY.slice();
    const CASE_PRIORITY_LAST = [{ value: "同上", id: 500 }].concat(PRIORITY.slice());
    // 类型
    const TYPE_STATUS_DELETE_ALL = TYPE_STATUS.slice();
    const TYPE_STATUS_LAST = [{ label: "同上", value: 500 }].concat(TYPE_STATUS.slice());
    const { searchParams, employeeLists, newEmployeeLists, newDemandLists } = useMixin();

    let newDemandLists_top = computed(() => [{ name: "无", id: 0 }].concat(newDemandLists.value));
    let demandLists_last = computed(() =>
      [
        { name: "同上", id: 500 },
        { name: "无", id: 0 }
      ].concat(newDemandLists.value)
    );

    let employeeLists_last = computed(() => [{ staff_name: "同上", value: 500 }].concat(newEmployeeLists.value));
    getPlanLists<ResponseParams.ResponseDataSuccess>().then((res) => {
      planLists.value = res.data;
      planLists_last.value = [{ plan: { id: 500, name: "同上" } }].concat(res.data);
    });

    const handlePlusTable = (index: number) => {
      // tableData.push({ ...rawTableData });
      tableData.value.splice(
        index + 1,
        0,
        Object.assign(
          { ...rawTableData },
          {
            staff_no: "500",
            type: "同上",
            staff_name: "同上",
            level: "同上",
            demand_id: "同上"
          }
        )
      );
    };
    const handleRemoveTable = (item: number) => {
      if (tableData.value.length <= 1) {
        return;
      }
      tableData.value.splice(item, 1);
    };
    // 检查日期是否正确
    const checkDate = (strInputDate: string) => {
      if (!strInputDate) return false;
      strInputDate = strInputDate.replace(/-/g, "/");
      var d: any = new Date(strInputDate);
      if (isNaN(d)) return false;
      var arr = strInputDate.split("/");
      return parseInt(arr[0], 10) == d.getFullYear() && parseInt(arr[1], 10) == d.getMonth() + 1 && parseInt(arr[2], 10) == d.getDate();
    };

    // 快捷导入弹框
    const exportShow = ref(false);
    // 文件上传前判断
    const beforeAvatarUpload = (file: any) => {
      if (!/\.(xls|xlsx)$/.test(file.name.toLowerCase())) {
        return tipMessage(400, `上传格式不正确，请上传xls或者xlsx格式`);
      }
    };
    const fileName = ref("");
    const exportData: any = ref([]);
    let timer: ReturnType<typeof setTimeout>;
    const uploadChange = async (file: any) => {
      if (!/\.(xls|xlsx)$/.test(file.name.toLowerCase())) {
        fileList.value.clearFiles();
        fileName.value = "";
        return tipMessage(400, `上传格式不正确，请上传xls或者xlsx格式`);
      }
      clearTimeout(timer);
      timer = setTimeout(async () => {
        let dataBinary = await readFile(file.raw);
        let workBook = xlsx.read(dataBinary, { type: "binary", cellDates: true });
        let workSheet = workBook.Sheets[workBook.SheetNames[0]];
        const data: any = xlsx.utils.sheet_to_json(workSheet, { raw: false });
        console.log("data---------");
        console.log(data);
        if (data && data.length) {
          const resultTable = [];
          for (let i = 0, l = data.length; i < l; i++) {
            if (data[i]["任务名称"]) {
              const obj: Record<string, any> = {};
              obj.name = data[i]["任务名称"];
              const type = TYPE_STATUS_DELETE_ALL.filter((item: Record<string, any>) => item.label === data[i]["类型"]);
              const level = CASEPRIORITY.filter((item: Record<string, any>) => item.value === data[i]["优先级"]);
              obj.type = type[0] ? type[0].value : 500;
              if (level.length) {
                obj.level = level[0].id ? level[0].id : "";
              } else {
                obj.level = "";
              }
              if (data[i]["工时"]) {
                obj.hours = data[i]["工时"] ? data[i]["工时"] * 1 : "";
              } else {
                obj.hours = data[i]["工时(h)"] ? data[i]["工时(h)"] * 1 : "";
              }
              if (i) {
                obj.demand_id = "同上";
                obj.staff_name = "同上";
                obj.staff_no = 500;
              } else {
                obj.staff_name = "";
                obj.staff_no = "";
                obj.demand_id = "";
              }
              const dateFormat1 = /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/;
              let start = "";
              if (dateFormat1.test(data[i]["开始时间"])) {
                const begin = data[i]["开始时间"].split("/");
                let beginTime = begin[0];
                const m1 = begin[1] * 1 > 9 ? begin[1] : "0" + begin[1] * 1;
                const d1 = begin[2] * 1 > 9 ? begin[2] : "0" + begin[2] * 1;
                start = beginTime + "-" + m1 + "-" + d1;
                if (!checkDate(start)) start = "";
              }

              let end = "";
              if (dateFormat1.test(data[i]["结束时间"])) {
                const last = data[i]["结束时间"].split("/");
                let endTime = last[0];
                const m2 = last[1] * 1 > 9 ? last[1] : "0" + last[1] * 1;
                const d2 = last[2] * 1 > 9 ? last[2] : "0" + last[2] * 1;
                end = endTime + "-" + m2 + "-" + d2;
                if (!checkDate(end)) end = "";
              }
              obj.begin_time = start;
              obj.last_time = end;
              obj.time = [start, end] as Array<string>;
              // 判断如果开始时间大于结束时间则将时间清空
              if (start && end) {
                if (end < start) {
                  obj.begin_time = "";
                  obj.last_time = "";
                  obj.time = [];
                }
              }
              // obj.staff_name = "";
              // obj.staff_no = "";
              obj.remark = data[i]["备注"] ? data[i]["备注"] : "";

              resultTable.push(obj);
            }
          }
          console.log(resultTable);
          exportData.value = resultTable;
          fileName.value = file.name;
          tipMessage(200, `上传成功`);
        } else {
          fileList.value.clearFiles();
          fileName.value = "";
          return tipMessage(400, `内容不能为空，请填写内容`);
        }
      }, 1000);
    };
    // 导入
    const handleExport = () => {
      exportShow.value = true;
    };
    // 取消导入
    const handleCancel = () => {
      exportShow.value = false;
    };

    // 确认导入数据
    const handleExportData = () => {
      if (!exportData.value.length) return tipMessage(400, `请上传xls或者xlsx格式文件`);

      let originTable = JSON.parse(JSON.stringify(tableData.value));
      for (let i = originTable.length - 1; i >= 0; i--) {
        if (!originTable[i].name) {
          originTable.splice(i, 1);
        } else {
          break;
        }
      }
      tableData.value = originTable;
      tableData.value.push.apply(tableData.value, exportData.value);
      exportShow.value = false;
      if (tableData.value.length > 30) {
        let loadingInstance1 = ElLoading.service({ fullscreen: true });

        setTimeout(() => {
          loadingInstance1.close();
        }, 3000);
      }
    };
    watch(
      () => exportShow.value,
      () => {
        exportData.value = [];
        fileName.value = "";
        if (!exportShow.value) {
          fileList.value.clearFiles();
        }
      }
    );

    const handleConfirmSave = () => {
      const post_table = JSON.parse(JSON.stringify(tableData.value));
      const resultTable = post_table.filter((v: Record<string, any>) => v.name !== "");
      console.log("过滤");
      console.log(resultTable);
      if (resultTable.length) {
        if (resultTable[0].demand_id === "同上" || resultTable[0].demand_id === 500) return tipMessage(400, `请选择第1条的需求`);
        if (!resultTable[0].staff_name || resultTable[0].staff_name === "同上") return tipMessage(400, `请选择第1条的指派人`);
        if (resultTable[0].type === "同上" || resultTable[0].type === 500) return tipMessage(400, `请选择第1条的类型`);
      }
      resultTable.forEach((itemObj: Record<string, any>, index: number) => {
        for (let key in itemObj) {
          if (itemObj[key] === 500 || itemObj[key] === "同上") {
            itemObj[key] = resultTable[index - 1][key as keyof typeof rawTableData];
          }
          if (key === "staff_name" && itemObj[key] && itemObj[key] !== "所有人") {
            const staff_no = newEmployeeLists.value.find((employee: Record<string, any>) => employee.staff_name === itemObj[key])?.staff_no;
            resultTable[index].staff_no = staff_no;
          }
        }
        if (itemObj.type === "") {
          tipMessage(400, `请选择第${index + 1}条的类型`);
          throw new Error("未选择类型！");
        }
        if (itemObj.staff_name === "" || itemObj.staff_no === "") {
          tipMessage(400, `请选择第${index + 1}条的指派人`);
          throw new Error("未选择指派人！");
        }
        if (itemObj.time && itemObj.time.length) {
          itemObj.begin_time = itemObj.time[0];
          itemObj.end_time = itemObj.time[1];
        } else {
          tipMessage(400, `请选择第${index + 1}条的起止时间`);
          throw new Error("未选择起止时间！");
        }
        if (!itemObj.end_time || !itemObj.begin_time) {
          tipMessage(400, `请选择第${index + 1}条的起止时间`);
          throw new Error("未选择起止时间！");
        }
        delete itemObj.time;
        if (!itemObj.level) {
          tipMessage(400, `请选择第${index + 1}条的优先级`);
          throw new Error("未选择优先级！");
        }
        if (!itemObj.hours || !itemObj.hours.toString().match(/\d/g)) {
          tipMessage(400, `请输入正确第${index + 1}条的工时`);
          throw new Error("工时错误！");
        }
        itemObj.iteration_id = searchParams.demand;
      });
      console.log(resultTable);
      if (resultTable.length) {
        if (isEdit.value) {
          updateTask<ResponseParams.ResponseDataSuccess>(resultTable).then((res) => {
            successCallBack(res.code);
          });
        } else {
          createTaskList<ResponseParams.ResponseDataSuccess>(resultTable).then((res) => {
            successCallBack(res.code);
          });
        }
      } else {
        router.go(-1);
      }

      const successCallBack = (code: number) => {
        tipMessage(code);
        if (code === 200) {
          router.go(-1);
        }
      };
    };
    return {
      handleConfirmSave,
      TYPE_STATUS_DELETE_ALL,
      TYPE_STATUS_LAST,
      CASE_PRIORITY_LAST,
      CASEPRIORITY,
      employeeLists,
      newEmployeeLists,
      employeeLists_last,
      newDemandLists_top,
      demandLists_last,
      planLists,
      planLists_last,
      handleRemoveTable,
      handlePlusTable,
      tableData,
      isEdit,
      fileList,
      exportShow,
      beforeAvatarUpload,
      uploadChange,
      handleExport,
      handleExportData,
      handleCancel,
      fileName
    };
  }
});
</script>

<style scoped lang="less">
// .content {
//   height: calc(100% - 70px) !important;
// }
.container {
  padding: 20px;
}
.main {
  height: 99%;
  display: inline-block;
  box-sizing: border-box;
}
.action {
  font-size: 20px;
  cursor: pointer;
}
:deep(.el-date-editor) {
  width: 240px !important;
}

:deep(.el-upload--text) {
  width: 100%;
}
:deep(.el-upload-dragger) {
  width: 100%;
}
</style>
