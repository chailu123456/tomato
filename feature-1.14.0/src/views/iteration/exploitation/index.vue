<template>
  <div class="exploitation">
    <page-table
      :tableData="list"
      :bugType="bugType"
      @handleSelectionChange="handleSelectionChange"
      @handlePagationChange="getData"
      :total="total"
      ref="pageTableRef"
      @sort-change="sortChange"
      :stopAutoGetData="stopAutoGetData"
      :currentPage="page"
    >
      <template #header>
        <el-form :inline="true" :model="formParams" @change="handleConditionSearch">
          <el-form-item label="" style="width: 130px">
            <el-input placeholder="请输入名称" v-model="formParams.name"></el-input>
          </el-form-item>
          <el-form-item class="rp-select" label="等级">
            <el-select
              v-model="formParams.level"
              placeholder="请选择"
              clearable
              @change="handleLevel"
              multiple
              collapse-tags
              @visible-change="handleConditionSearch"
              @remove-tag="handleConditionSearch"
            >
              <el-option v-for="item in PRIORITY" :key="item.id" :label="item.value" :value="item.id"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item class="rp-select" label="类型">
            <el-select
              v-model="formParams.type"
              placeholder="请选择"
              clearable
              @change="handleType"
              multiple
              collapse-tags
              @visible-change="handleConditionSearch"
              @remove-tag="handleConditionSearch"
            >
              <el-option v-for="item in TYPE_STATUS" :key="item.value" :label="item.label" :value="item.value"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item class="rp-select" label="状态">
            <el-select
              v-model="formParams.status"
              placeholder="请选择"
              clearable
              @change="handleStatus"
              multiple
              collapse-tags
              @visible-change="handleConditionSearch"
              @remove-tag="handleConditionSearch"
            >
              <el-option v-for="item in task_select" :key="item.value" :label="item.label" :value="item.value"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item class="rp-select" label="指派给">
            <el-select
              @change="setFiled"
              v-model="formParams.tempStaff"
              value-key="staff_no"
              filterable
              placeholder="请选择"
              multiple
              clearable
              collapse-tags
              @visible-change="handleConditionSearch"
              @remove-tag="handleConditionSearch"
            >
              <el-option-group v-for="group in employeeLists" :key="group.staff_no" :label="group.label">
                <el-option v-for="item in group.options" :key="item.staff_no" :label="item.staff_name" :value="item.staff_name"></el-option>
              </el-option-group>
            </el-select>
          </el-form-item>
          <el-form-item>
            <el-select class="timeType" @change="handleTime" v-model="formParams.timeType">
              <el-option v-for="item in timeOptions" :key="item.id" :label="item.label" :value="item.id"> </el-option>
            </el-select>
            <el-date-picker
              @change="handleTime"
              v-model="formParams.time"
              style="width: 240px"
              type="daterange"
              range-separator="-"
              start-placeholder="请选择日期"
              end-placeholder="请选择日期"
              value-format="YYYY-MM-DD"
            ></el-date-picker>
          </el-form-item>
          <router-link to="/project/iteration/exploitationAdd" class="all-option">
            <el-button type="primary">批量添加</el-button>
          </router-link>
          <el-button @click="exportTaskDate" class="all-option" type="primary">导 出</el-button>
        </el-form>
      </template>
      <template #main>
        <el-table-column type="selection" width="55"></el-table-column>
        <el-table-column sortable="custom" prop="level" label="P" width="80" #default="scope">
          <span :style="{ color: PRIORITY[scope.row.level - 1].color }">{{ PRIORITY[scope.row.level - 1].value }}</span>
        </el-table-column>
        <el-table-column prop="id" label="ID" sortable="custom" width="70"></el-table-column>
        <el-table-column prop="name" sortable="custom" class-name="table-column-left table-title" label="名称" min-width="300"></el-table-column>
        <el-table-column prop="demand_name" width="140" sortable="custom" label="需求">
          <template #default="scope">
            <span>{{ getDemandName(scope.row.demand_id) }}</span>
          </template>
        </el-table-column>
        <el-table-column prop="type" label="类型" sortable="custom" width="80">
          <template #default="scope">
            <span>{{ getType(scope.row.type) }}</span>
          </template>
        </el-table-column>

        <el-table-column prop="staff_name" sortable="custom" label="指派给" width="90">
          <template #default="scope">
            <i class="iconfont icon-shouzhi rotate-icon" v-if="scope.row.staff_name"></i>
            <span
              :class="[scope.row.is_sys ? 'no-click' : '', staffNo === scope.row.staff_no && scope.row.status !== 3 ? `rp-Table__bugSelf` : `rp-Table__bug`]"
              @click="handleChangeAssign(scope.row)"
              >{{ scope.row.staff_name }}</span
            >
          </template>
        </el-table-column>
        <el-table-column prop="status" sortable="custom" label="状态" width="100">
          <template #default="scope">
            <span @click="handleChangeProgress(scope.row)" class="rp-Table__common" :style="getTextColor(scope.row.status)">
              <i class="iconfont icon-shouzhi rotate-icon"></i>
              {{ getStatus(scope.row.status) }}
            </span>
          </template>
        </el-table-column>
        <el-table-column prop="complete_percent" sortable="custom" label="进度" width="80">
          <template #default="scoped">
            <span>{{ scoped.row.complete_percent }}%</span>
          </template>
        </el-table-column>
        <el-table-column prop="hours" label="工时" sortable="custom" width="80"></el-table-column>
        <el-table-column prop="begin_time" width="210" label="预计起止" sortable="custom">
          <template #default="scope">
            <span :style="{ color: timeCheck(scope.row, 0) }">{{ scope.row.begin_time }}</span> -
            <span :style="{ color: timeCheck(scope.row, 1) }">{{ scope.row.end_time }}</span>
          </template>
        </el-table-column>
        <el-table-column prop="real_begin_time" width="210" label="实际起止" sortable="custom">
          <template #default="scope">
            <span>{{ scope.row.real_begin_time }} - {{ scope.row.real_end_time }}</span>
          </template>
        </el-table-column>

        <el-table-column prop="remark" class-name="table-column-left" min-width="120" label="备注">
          <template #default="scope">
            <span>{{ scope.row.remark || "-" }}</span>
          </template>
        </el-table-column>
        <el-table-column label="操作">
          <template #default="scoped">
            <el-button type="text" @click="handleUpdateList(scoped.row)">编辑</el-button>
          </template>
        </el-table-column>
      </template>
      <template #qucikSelect>
        <div class="rp-test-list-num">
          <span class="rp-test-num">总工时 {{ bugType.total_hours }} h</span>
          <span class="rp-test-num" @click="handleTypeList('no', [0, 1])">未完成 {{ bugType.remain_hours }} h</span>
          <span class="rp-test-num">进度 {{ bugType.hour_percent }} %</span>
        </div>
      </template>
    </page-table>
    <div class="rp-use-case-opation" v-if="selectMore.length">
      <el-button @click="handleUpdateList(0)">编辑</el-button>
      <el-divider direction="vertical"></el-divider>
      <el-dropdown size="small" @command="(id) => handleCommand(id)">
        <el-button>
          状 态
          <i class="el-icon-arrow-up el-icon--right"></i>
        </el-button>
        <template #dropdown>
          <el-dropdown-menu v-for="(item, index) in TYPE_STATUS_COPY" :key="index">
            <el-dropdown-item :command="item.value">
              <em
                :style="{
                  width: '10px',
                  height: '10px',
                  marginRight: '8px',
                  display: 'inline-block',
                  borderRadius: '5px',
                  background: item.color
                }"
              ></em>

              <span :style="{ color: item.color }">{{ item.label }}</span>
            </el-dropdown-item>
          </el-dropdown-menu>
        </template>
      </el-dropdown>
      <el-divider direction="vertical"></el-divider>
      <el-dropdown size="small" @command="(item) => handleUpdateAssign(item)">
        <el-button>
          指派给
          <i class="el-icon-arrow-up el-icon--right"></i>
        </el-button>
        <template #dropdown>
          <el-dropdown-menu v-for="(item, index) in employeeLists[1]?.options" :key="index">
            <el-dropdown-item :command="item">
              <span>{{ item.staff_name }}</span>
            </el-dropdown-item>
          </el-dropdown-menu>
        </template>
      </el-dropdown>
      <el-divider direction="vertical"></el-divider>
      <el-dropdown size="small" @command="(n: number) => handlebatch(n)">
        <el-button>
          优先级
          <i class="el-icon-arrow-up el-icon--right"></i>
        </el-button>
        <template #dropdown>
          <el-dropdown-menu v-for="(item, index) in PRIORITY" :key="index">
            <el-dropdown-item :command="item.id">
              <span :style="{ color: item.color }">{{ item.value }}</span>
            </el-dropdown-item>
          </el-dropdown-menu>
        </template>
      </el-dropdown>
    </div>

    <!-- 编辑状态框 -->
    <el-dialog center title="编辑状态" v-model="isOpenEditProgress" width="30%">
      <div>
        <el-form label-width="80px" :model="dialogFormData">
          <el-form-item label="状态:">
            <el-select v-model="dialogFormData.status" placeholder="请选择" @change="handleChangeStatus">
              <el-option v-for="item in TYPE_STATUS_COPY" :key="item.value" :label="item.label" :value="item.value"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="进度">
            <el-input-number @change="handleChangeInputNumber" v-model="dialogFormData.complete_percent" :min="0" :max="100"></el-input-number>
          </el-form-item>
        </el-form>
      </div>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="isOpenEditProgress = false">取 消</el-button>
          <el-button type="primary" v-debounce @click="handleUpdateStatus">确 定</el-button>
        </span>
      </template>
    </el-dialog>
    <!-- 指派给 弹框 -->
    <el-dialog center title="指派给" v-model="isOpenEditAssign" width="30%">
      <div class="rp-assign">
        <el-form label-width="80px" :model="assignFormData">
          <el-form-item label="指派给" prop="status">
            <el-select
              value-key="staff_no"
              filterable
              @change="handleStaff"
              collapse-tags
              v-model="assignFormData.staff_no_obj.staff_name"
              placeholder="--所有--"
            >
              <el-option-group v-for="group in employeeLists" :key="group.staff_no" :label="group.label">
                <el-option v-for="item in group.options" :key="item.staff_no" :label="item.staff_name" :value="item.staff_name"></el-option>
              </el-option-group>
            </el-select>
          </el-form-item>
        </el-form>
      </div>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="isOpenEditAssign = false">取 消</el-button>
          <el-button type="primary" v-debounce @click="handleUpdateAssign">确 定</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script lang="ts">
import { defineComponent, reactive, toRefs, ref, watch, onActivated } from "vue";
import { TYPE_STATUS, TASK_TYPE, PRIORITY, setObjStringify } from "@/utils";
import { Pagation } from "@/composables/usePagation";
import useRequest from "@/composables/useRequest";
import useRenderTable from "@/composables/useRenderTable";
import useFetchSearch from "./composables/useFetchSearch";
import useMixin from "../useMixin";
import { updateTaskList, giveTask, updateTaskListLevel } from "@/api/request-modules/iteration";
import { ResponseParams } from "@/types/response";
import useMessageTip from "@/composables/useMessageTip";
import { useRouter, useRoute } from "vue-router";
import { setSession } from "@/utils/sesssion";
import { useStore } from "@/store/index";
import dayjs from "dayjs";

export default defineComponent({
  name: "exploitation",
  setup() {
    const router = useRouter();
    const route = useRoute();
    const store = useStore();
    const { tipMessage } = useMessageTip();
    const dialogFormData = reactive<any>({
      status: null,
      ids: [],
      complete_percent: 0
    });
    const tableData = reactive({
      list: [],
      total: 0,
      bugType: {
        hour_percent: 0,
        remain_hours: 0,
        total_hours: 0
      }
    });
    const page = ref(1);
    // 判断是否进行筛选
    const flag = ref<boolean>(false);
    const pageTableRef = ref<any>();
    const stopAutoGetData = ref<boolean>(false);
    const { searchParams, handleGetIterationList, employeeLists, newDemandLists } = useMixin();
    handleGetIterationList();
    let _cacheCompletePercent = 0;
    const formParams: any = reactive({
      tempStaff: [] as Array<string>,
      staff_no: [] as Array<string>,
      staff_name: [] as Array<string>,
      type: [],
      name: null,
      status: [],
      end_time: "",
      create_time: "",
      time: "",
      timeType: 1
    });
    const timeOptions = [
      {
        id: 1,
        label: "预计开始"
      },
      {
        id: 2,
        label: "预计结束"
      },
      {
        id: 3,
        label: "实际开始"
      },
      {
        id: 4,
        label: "实际结束"
      }
    ];

    const timeCheck = (params: Record<string, any>, type: number) => {
      const colorDefault = "#606266";
      const colorOne = "#ff0000";
      const curTime = dayjs().format("YYYY-MM-DD");
      if (!type) {
        // 先判断状态没有开始，status=0
        if (!params.status) {
          if (curTime >= params.begin_time) return colorOne;
        }
        if (params.status === 5 && !params.real_begin_time) {
          if (curTime >= params.begin_time) return colorOne;
        }
        // 直接选延期（即状态还未进行中）
        if (params.status === 4 && !params.real_begin_time) return colorOne;
        // 状态开始，判断实际开始时间是否大于预计开始
        if (params.real_begin_time && params.real_begin_time > params.begin_time) return colorOne;

        return colorDefault;
      } else {
        if (params.real_end_time && params.real_end_time > params.end_time) return colorOne;
        // 直接选延期（即状态还未进行中）
        if (params.status === 4 && !params.real_end_time) return colorOne;

        if (!params.real_end_time && params.end_time < curTime) return colorOne;
        return colorDefault;
      }
    };

    // 表格多选
    const selectMore: any = ref([]);

    const hasStaffNo = () => {
      // 进入页面判断路由是否携带了staffNo，如果有，修改默认筛选条件
      const { staffNo, staffName } = route.query;
      if (staffNo) {
        formParams.staff_no = [staffNo as string];
        formParams.staff_name = [staffName as string];
        formParams.tempStaff = [staffName as string];
      }
    };
    hasStaffNo();
    const setFiled = (staff: Array<ProxyHandler<Record<string, any>>>) => {
      flag.value = true;

      if (!staff.length) {
        formParams.staff_name = [];
        formParams.staff_no = [];
        getData(pageTableRef.value.getCurrentPage());
        return;
      }
      formParams.staff_no = [];
      formParams.staff_name = [];
      const list: Record<string, any> = employeeLists.value[1];
      list.options.forEach((item: any) => {
        staff.forEach((v) => {
          if (v === item.staff_name) {
            formParams.staff_no.push(item.staff_no);
            formParams.staff_name.push(item.staff_name);
          }
        });
      });
      // formParams.staff_no = formParams.tempStaff.map((v: Record<string, any>) => v.staff_no);
      // formParams.staff_name = formParams.tempStaff.map((v: Record<string, any>) => v.staff_name);
      // // 路由如果有这个参数，就修改路由参数
      if (route.query.staffName && formParams.staff_name) {
        router.replace({
          query: Object.assign(
            { ...router.currentRoute.value.query },
            {
              id: searchParams.demand,
              staffNo: formParams.staff_no.join(","),
              staffName: formParams.staff_name.join(",")
            }
          )
        });
      }
    };

    onActivated(() => {
      if (route.query.iteration_id) {
        formParams.name = route.query.name || "";
      }
      setTimeout(() => {
        hasStaffNo();
        handleGetIterationList();
        getData(pageTableRef.value.getCurrentPage());
      }, 300);
    });

    const tableHeight = () => {
      setTimeout(() => {
        const contentHeight = document.getElementsByClassName("content")[0] as HTMLDivElement;
        const headerHeight = document.getElementsByClassName("search-header")[0] as HTMLDivElement;
        pageTableRef.value.height = contentHeight.offsetHeight - headerHeight.offsetHeight - 140;
      }, 100);
    };

    // 分页以及获取数据
    const getData = async (pagationParams?: Pagation, flag?: boolean, params?: any) => {
      stopAutoGetData.value = flag == undefined ? false : true;
      page.value = (pagationParams && pagationParams.pageIndex) || 1;

      const paramsObj = JSON.parse(JSON.stringify(params || Object.assign(formParams, { iteration_id: searchParams.demand })));
      Reflect.deleteProperty(paramsObj, "tempStaff");
      const { response } = useRequest(useFetchSearch, paramsObj);
      const { pagation } = useRenderTable(response);
      let {
        data: { list, count, hour_percent, remain_hours, total_hours }
      } = await pagation(pagationParams);
      tableData.total = count;
      tableData.list = list;
      tableData.bugType.hour_percent = hour_percent;
      tableData.bugType.remain_hours = remain_hours;
      tableData.bugType.total_hours = total_hours;
      tableHeight();
    };
    getData();
    const handleConditionSearch = async (isHiddenSelect?: boolean) => {
      if (isHiddenSelect === true) {
        return;
      }
      if (flag.value) {
        pageTableRef.value.setCurrentPage();
        page.value = 1;
        await getData({ pageIndex: 1, pageSize: 20 }, true, Object.assign(formParams, { iteration_id: searchParams.demand }));
        flag.value = false;
      } else {
        await getData(pageTableRef.value.getCurrentPage(), true, Object.assign(formParams, { iteration_id: searchParams.demand }));
      }
      stopAutoGetData.value = false;
      await handleGetIterationList();
    };
    const getType = (type: number) => {
      return TYPE_STATUS.find((t) => t.value === type)?.label;
    };
    const getDemandName = (type: number) => {
      return newDemandLists.value.find((t: Record<string, any>) => t.id === type)?.name || "-";
    };

    watch(
      () => searchParams.demand,
      () => {
        handleConditionSearch();
      }
    );
    // 未完成、已完成、P0快捷事件
    const handleTypeList = (isType: string, params: number[]) => {
      if (isType === "P0") formParams.level = params;
      else formParams.status = params;

      handleConditionSearch();
    };

    const getStatus = (status: number) => {
      return TASK_TYPE.find((t) => t.value === status)?.label;
    };
    const handleType = (val: number[]) => {
      flag.value = true;

      if (!val.length) {
        formParams.type = [];
        handleConditionSearch();
      }
    };
    const handleLevel = (val: number[]) => {
      flag.value = true;

      if (!val.length) {
        formParams.level = [];
        handleConditionSearch();
      }
    };
    const handleStatus = (val: number[]) => {
      flag.value = true;
      if (!val.length) {
        formParams.status = [];
        handleConditionSearch();
      }
    };
    // 批量添加
    const handleAddDate = () => {
      router.push({ name: "exploitationAdd" });
    };

    // 导出
    const exportTaskDate = async () => {
      let exportForm = JSON.parse(JSON.stringify(formParams));
      if (exportForm.time && exportForm.time.length) {
        exportForm.expected_start_time = exportForm.time;
        // exportForm.expected_start_time = exportForm.time[1];
        delete exportForm.time;
      }
      if (!tableData.total) return tipMessage(400, "暂无数据，无法导出");
      setObjStringify(exportForm, "/api/tomato/task/export");
    };

    // 批量优先级
    const handlebatch = (val: number) => {
      let ids: number[] = [];
      selectMore.value?.forEach((item: Record<string, any>) => {
        ids.push(item.id);
      });
      let params = {
        ids: ids,
        level: val
      };
      if (!ids.length) return tipMessage(400, "请选择除已作废状态的需求进行批量修改优先级");
      updateTaskListLevel<ResponseParams.ResponseDataSuccess>(params).then(() => {
        handleConditionSearch();
      });
    };
    const task_select = JSON.parse(JSON.stringify(TASK_TYPE));
    task_select.splice(-1, 1);
    let TYPE_STATUS_COPY = TASK_TYPE.slice();
    // 更新状态
    // scoped.row.id, scoped.row.status,scoped.row.complete_percent
    const handleChangeProgress = (row: Record<string, any>) => {
      const { id, status, complete_percent } = row;
      dialogFormData.status = status;
      dialogFormData.ids = [id];
      dialogFormData.complete_percent = complete_percent;
      _cacheCompletePercent = complete_percent;
      isOpenEditProgress.value = true;
    };
    const handleUpdateStatus = () => {
      updateTaskList<ResponseParams.ResponseDataSuccess>(dialogFormData).then((res: any) => {
        tipMessage(res.code);
        getData(pageTableRef.value.getCurrentPage());
        isOpenEditProgress.value = false;
      });
    };
    // 结果 -- 批量修改状态
    const handleCommand = (command: string) => {
      handleChangeStatus(Number(command));
      dialogFormData.status = Number(command);
      dialogFormData.ids = [];
      if (selectMore.value && selectMore.value.length) {
        selectMore.value.forEach((item: Record<string, any>) => {
          dialogFormData.ids.push(item.id);
        });
      } else {
        return tipMessage(400, "请选择列表");
      }
      handleUpdateStatus();
    };
    let isOpenEditProgress = ref(false);
    const handleUpdateList = (row: Record<string, any>) => {
      // setSession("editTask", row);
      if (row) {
        setSession("editTask", JSON.stringify([row]));
      } else {
        if (selectMore.value && selectMore.value.length) {
          setSession("editTask", JSON.stringify(selectMore.value));
        } else {
          return tipMessage(400, "请选择要批量操作的列表");
        }
      }

      router.push({
        name: "exploitationAdd",
        query: Object.assign(
          {
            isEdit: 1
          },
          { ...router.currentRoute.value.query }
        )
      });
    };
    //#region  更改状态弹窗
    const NOT_START = 0;
    const UNDERWAY = 1;
    const FINISHED = 2;
    const CLOSE = 3;
    const handleChangeStatus = (val: number) => {
      if (val === NOT_START) {
        dialogFormData.complete_percent = 0;
      } else if (val === UNDERWAY) {
        if (_cacheCompletePercent) {
          dialogFormData.complete_percent = _cacheCompletePercent;
        } else {
          dialogFormData.complete_percent = 1;
        }
      } else if (val === FINISHED || val === CLOSE) {
        dialogFormData.complete_percent = 100;
      }
    };
    const handleChangeInputNumber = (currentValue: number) => {
      // change
      if (currentValue === NOT_START) {
        dialogFormData.status = NOT_START;
      } else if (currentValue >= 1 && currentValue < 100) {
        dialogFormData.status = UNDERWAY;
      } else if (currentValue === 100) {
        dialogFormData.status = FINISHED;
      }
    };
    const isOpenEditAssign = ref(false);
    const assignFormData = reactive({
      id: 0,
      remark: null,
      staff_no_obj: {
        staff_no: "",
        staff_name: ""
      } as Record<string, any>
    });
    const handleChangeAssign = (row: Record<string, any>) => {
      console.log("row");
      console.log(row);
      assignFormData.staff_no_obj = {
        staff_no: row.staff_no,
        staff_name: row.staff_name
      };
      assignFormData.id = row.id;
      isOpenEditAssign.value = true;
    };
    let obj: any = {
      staff_name: assignFormData.staff_no_obj.staff_name,
      staff_no: assignFormData.staff_no_obj.staff_no,
      task_ids: [0]
    };
    // 确定指派
    const handleUpdateAssign = (item: Record<string, any>) => {
      if (item.staff_no) {
        console.log(item);
        obj.staff_no = item.staff_no;
        obj.staff_name = item.staff_name;
        obj.task_ids = [];
        if (selectMore.value && selectMore.value.length) {
          selectMore.value.forEach((item: Record<string, any>) => {
            obj.task_ids.push(item.id);
          });
        } else {
          return tipMessage(400, "请选择列表");
        }
      } else {
        obj.task_ids = [assignFormData.id];
      }
      giveTask<ResponseParams.ResponseDataSuccess>(obj).then((res: any) => {
        tipMessage(res.code);
        getData(pageTableRef.value.getCurrentPage());
        isOpenEditAssign.value = false;
      });
    };

    const handleStaff = (name: string) => {
      const list: Record<string, any> = employeeLists.value[1];
      list.options.forEach((item: any) => {
        if (name === item.staff_name) {
          obj.staff_name = item.staff_name;
          obj.staff_no = item.staff_no;
        }
      });
    };
    const handleSelectionChange = (val: any) => {
      selectMore.value = val;
    };

    //#endregion
    const getTextColor = (status: number) => {
      const list = TASK_TYPE.find((v: { value: number; label: string }) => v.value === status);
      return {
        color: list?.color
      };
    };

    // 自定义排序
    const sortChange = (e: any) => {
      const { prop, order } = e;
      if (!order) return;
      formParams.sort_name = prop;
      formParams.sort_by = order === "ascending" ? 1 : 2;
      getData(pageTableRef.value.getCurrentPage(), undefined, formParams);
    };

    // 预计时间
    const handleTime = () => {
      flag.value = true;

      const form = Object.assign({}, formParams);
      const { timeType, time } = form;
      delete formParams.expected_start_time;
      delete formParams.expected_end_time;
      delete formParams.actual_start_time;
      delete formParams.actual_end_time;
      if (time) {
        switch (timeType) {
          case 1:
            formParams.expected_start_time = time;
            break;
          case 2:
            formParams.expected_end_time = time;
            break;
          case 3:
            formParams.actual_start_time = time;
            break;
          case 4:
            formParams.actual_end_time = time;
            break;
        }
      }
      getData(pageTableRef.value.getCurrentPage(), undefined, formParams);
    };
    return {
      handleTime,
      timeOptions,
      sortChange,
      staffNo: store.getters.user.staff_no,
      getTextColor,
      handleChangeInputNumber,
      handleChangeStatus,
      handleUpdateList,
      TYPE_STATUS,
      TYPE_STATUS_COPY,
      task_select,
      employeeLists,
      setFiled,
      pageTableRef,
      stopAutoGetData,
      handleConditionSearch,
      ...toRefs(tableData),
      getType,
      getDemandName,
      getStatus,
      getData,
      handleUpdateStatus,
      dialogFormData,
      isOpenEditProgress,
      handleChangeProgress,
      formParams,
      TASK_TYPE,
      page,

      PRIORITY,
      handleTypeList,

      isOpenEditAssign,
      handleChangeAssign,
      assignFormData,
      handleUpdateAssign,
      handleType,
      handleLevel,
      handleStatus,
      handleStaff,
      handleSelectionChange,
      selectMore,
      handleCommand,
      handlebatch,
      timeCheck,
      exportTaskDate,
      handleAddDate
    };
  }
});
</script>

<style scoped lang="less">
.progress-padding {
  padding-left: 10px;
}
.all-option {
  float: right;
  margin-right: 8px;
}
.rotate-icon {
  transform: rotate(90deg);
  margin-right: 5px;
  color: #3370ff;
}
.rp-Table__common {
  font-size: 12px;
  cursor: pointer;
  &:hover {
    text-decoration: underline;
    opacity: 0.8;
  }
}
.rp-test-list-num {
  float: left;
  span.rp-test-num {
    display: inline-block;
    padding: 0px 6px;
    font-size: 13px;
    margin: 0 6px;
    background: #c4efe6;
    color: #606266;
    border-radius: 4px;
    font-weight: 500;
    &:hover {
      cursor: pointer;
      color: #3f3f40;
    }
  }
  :deep(.el-pagination__total) {
    display: inline-block;
    background: #f4f4f5;
    padding: 2px 6px;
    line-height: 20px;
    height: 20px;
    margin-top: 4px;
    border-radius: 4px;
    box-sizing: none;
  }
}
:deep(.rp-select) {
  .el-input {
    width: 140px;
  }
  .el-select__tags {
    max-width: 120px !important;
  }
  .el-select__tags-text {
    max-width: 50px !important;
  }
}

.rp-Table__bug {
  .rp-Table__common;
  color: #3370ff;
}
.rp-Table__bugSelf {
  .rp-Table__common;
  color: #ff0000;
}
.no-click {
  pointer-events: none;
  cursor: default;
  color: #c0c4cc;
}
.rp-assign {
  :deep(.el-form-item__content) {
    display: flex !important;
  }
}
.rp-use-case-opation {
  z-index: 999;
  position: absolute;
  left: 80px;
  margin-top: -70px;
}
:deep(.page) {
  padding-top: 20px;
}
.exploitation {
  .timeType {
    width: 100px;

    :deep(.el-input__wrapper) {
      box-shadow: none;
    }
  }
}
</style>
