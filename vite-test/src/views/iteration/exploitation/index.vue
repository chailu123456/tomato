<template>
  <div>
    <page-table :tableData="list" @handlePagationChange="getData" :total="total" ref="pageTableRef" :stopAutoGetData="stopAutoGetData">
      <template #header>
        <el-form :inline="true" :model="formParams">
          <el-form-item label="名称:">
            <el-input v-model="formParams.name"></el-input>
          </el-form-item>
          <el-form-item label="类型:">
            <el-select v-model="formParams.type" placeholder="请选择">
              <el-option v-for="item in TYPE_STATUS" :key="item.value" :label="item.label" :value="item.value"> </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="状态:">
            <el-select v-model="formParams.status" placeholder="请选择">
              <el-option v-for="item in TASK_TYPE" :key="item.value" :label="item.label" :value="item.value"> </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="指派给:">
            <el-select v-model="formParams.staff_name" filterable placeholder="请选择" @change="setFiled" clearable>
              <el-option v-for="item in employeeLists" :key="item.staff_no" :label="item.staff_name" :value="item.staff_name"> </el-option>
            </el-select>
          </el-form-item>
          <el-button type="primary" @click="handleConditionSearch">查询</el-button>
          <router-link to="/iteration/exploitationAdd" class="margin-left">
            <el-button type="primary">批量添加</el-button>
          </router-link>
        </el-form>
      </template>
      <template #main>
        <el-table-column prop="id" label="编号" width="50"> </el-table-column>
        <el-table-column prop="name" label="名称" width="300"> </el-table-column>
        <el-table-column prop="type" label="类型" width="80">
          <template #default="scope">
            <span>{{ getType(scope.row.type) }}</span>
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态" width="80">
          <template #default="scope">
            <span>{{ getStatus(scope.row.status) }}</span>
          </template>
        </el-table-column>
        <el-table-column prop="staff_name" label="指派给" width="80"> </el-table-column>
        <el-table-column prop="begin_time" label="预计开始时间"> </el-table-column>
        <el-table-column prop="end_time" label="预计结束时间"> </el-table-column>
        <el-table-column prop="real_begin_time" label="开始时间"> </el-table-column>
        <el-table-column prop="real_end_time" label="结束时间"> </el-table-column>
        <el-table-column prop="hours" label="工时" width="80"> </el-table-column>
        <el-table-column prop="complete_percent" label="进度" width="80">
          <template #default="scoped">
            <span>{{ scoped.row.complete_percent }}%</span>
          </template>
        </el-table-column>
        <el-table-column prop="remark" label="备注"> </el-table-column>
        <el-table-column label="操作" width="120">
          <template #default="scoped">
            <el-button type="text" @click="handleUpdateList(scoped.row)">编辑</el-button>
            <el-divider direction="vertical"></el-divider>
            <el-button type="text" @click="handleChangeProgress(scoped.row)">状态</el-button>
          </template>
        </el-table-column>
      </template>
    </page-table>
    <el-dialog center title="编辑状态" v-model="isOpenEditProgress" width="30%">
      <div>
        <el-form label-width="80px" :model="dialogFormData">
          <el-form-item label="状态:">
            <el-select v-model="dialogFormData.status" placeholder="请选择" @change="handleChangeStatus">
              <el-option v-for="item in DELETE_TYPE_STATUS" :key="item.value" :label="item.label" :value="item.value"> </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="进度">
            <el-input-number @change="handleChangeInputNumber" v-model="dialogFormData.complete_percent" :min="0" :max="100"></el-input-number>
          </el-form-item>
        </el-form>
      </div>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="isOpenEditProgress = false">取 消</el-button>
          <el-button type="primary" @click="handleUpdateStatus">确 定</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script lang="ts">
import { defineComponent, reactive, toRefs, ref, computed, watch } from "vue";
import { TYPE_STATUS, TASK_TYPE } from "@/utils";
import { useStore } from "@/store";
import { Pagation } from "@/composables/usePagation";
import useRequest from "@/composables/useRequest";
import useRenderTable from "@/composables/useRenderTable";
import useFetchSearch from "./composables/useFetchSearch";
import useMixin from "../useMixin";
import { updateTaskList } from "@/api/request-modules/iteration";
import { ResponseParams } from "@/types/response";
import useMessageTip from "@/composables/useMessageTip";
import { useRouter } from "vue-router";
import { setSession } from "@/utils/sesssion";
export default defineComponent({
  name: "allOverview",
  setup() {
    const router = useRouter();
    const { tipMessage } = useMessageTip();
    const dialogFormData = reactive<any>({
      status: null,
      id: null,
      complete_percent: 0
    });
    const employeeLists = computed(() => useStore() && useStore().getters.employeeLists);
    const tableData = reactive({
      list: [],
      total: 0
    });
    const pageTableRef = ref<any>();
    const stopAutoGetData = ref<boolean>(false);
    const { searchParams } = useMixin();
    let _cacheCompletePercent = 0;
    const jobName = reactive<Record<string, any>>({
      staff_no: null,
      staff_name: null
    });
    const formParams = reactive({
      staff_no: null,
      // staff_name: null,
      type: -1,
      name: null,
      status: -1
    });
    const setFiled = (staff_name: string) => {
      if (!staff_name) {
        formParams.staff_no = null;
        return;
      }
      const staff_no = employeeLists.value.find((list: Record<string, any>) => list.staff_name === staff_name).staff_no;
      formParams.staff_no = staff_no;
    };

    // 分页以及获取数据
    const getData = async (pagationParams?: Pagation, flag?: boolean, params?: any) => {
      stopAutoGetData.value = flag == undefined ? false : true;
      const { response } = useRequest(useFetchSearch, params || Object.assign(formParams, { iteration_id: searchParams.demand }));
      const { pagation } = useRenderTable(response);
      let {
        data: { list, count }
      } = await pagation(pagationParams);
      tableData.total = count;
      tableData.list = list;
    };
    getData();
    const handleConditionSearch = async () => {
      await getData(undefined, true, Object.assign(formParams, { iteration_id: searchParams.demand }));
      stopAutoGetData.value = false;
    };
    const getType = (type: number) => {
      return TYPE_STATUS.find((t) => t.value === type)?.label;
    };
    watch(
      () => searchParams.demand,
      () => {
        handleConditionSearch();
      }
    );
    const getStatus = (status: number) => {
      return TASK_TYPE.find((t) => t.value === status)?.label;
    };

    let DELETE_TYPE_STATUS = TASK_TYPE.slice().splice(1, TASK_TYPE.length);
    // 更新状态
    // scoped.row.id, scoped.row.status,scoped.row.complete_percent
    const handleChangeProgress = (row: Record<string, any>) => {
      const { id, status, complete_percent } = row;
      dialogFormData.status = status;
      dialogFormData.id = id;
      dialogFormData.complete_percent = complete_percent;
      _cacheCompletePercent = complete_percent;
      isOpenEditProgress.value = true;
    };
    const handleUpdateStatus = () => {
      updateTaskList<ResponseParams.ResponseDataSuccess>(dialogFormData).then((res: any) => {
        tipMessage(res.code);
        getData(pageTableRef.value.getCurrentPage());
        isOpenEditProgress.value = false;
      });
    };
    let isOpenEditProgress = ref(false);
    const handleUpdateList = (row: any) => {
      setSession("editTask", row);
      router.push({
        path: "/iteration/exploitationAdd",
        query: Object.assign(
          {
            isEdit: 1
          },
          { ...router.currentRoute.value.query }
        )
      });
    };
    //#region  更改状态弹窗
    const NOT_START = 0;
    const UNDERWAY = 1;
    const FINISHED = 2;
    const handleChangeStatus = (val: number) => {
      if (val === NOT_START) {
        dialogFormData.complete_percent = 0;
      } else if (val === UNDERWAY) {
        if (_cacheCompletePercent) {
          dialogFormData.complete_percent = _cacheCompletePercent;
        } else {
          dialogFormData.complete_percent = 1;
        }
      } else if (val === FINISHED) {
        dialogFormData.complete_percent = 100;
      }
    };
    const handleChangeInputNumber = (currentValue: number) => {
      // change
      console.log(currentValue);
      if (currentValue === NOT_START) {
        dialogFormData.status = NOT_START;
      } else if (currentValue >= 1 && currentValue < 100) {
        dialogFormData.status = UNDERWAY;
      } else if (currentValue === 100) {
        dialogFormData.status = FINISHED;
      }
    };
    //#endregion
    return {
      handleChangeInputNumber,
      handleChangeStatus,
      handleUpdateList,
      TYPE_STATUS,
      DELETE_TYPE_STATUS,
      employeeLists,
      setFiled,
      pageTableRef,
      stopAutoGetData,
      jobName,
      handleConditionSearch,
      ...toRefs(tableData),
      getType,
      getStatus,
      getData,
      handleUpdateStatus,
      dialogFormData,
      isOpenEditProgress,
      handleChangeProgress,
      formParams,
      TASK_TYPE
    };
  }
});
</script>

<style scoped lang="less">
.progress-padding {
  padding-left: 10px;
}
.margin-left {
  margin-left: 10px;
}
</style>
