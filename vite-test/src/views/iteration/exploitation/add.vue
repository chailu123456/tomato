<template>
  <div class="container">
    <div class="main">
      <el-button type="primary" @click="handleConfirmSave"> 确定</el-button>
      <el-table :data="tableData">
        <el-table-column type="index" width="50" label="序号"> </el-table-column>
        <el-table-column prop="name" label="任务名称" width="350">
          <template #default="scoped">
            <el-input v-model="scoped.row.name" maxlength="50" placeholder="请输入不超过50字的任务名称"></el-input>
          </template>
        </el-table-column>
        <el-table-column prop="type" label="类型" width="150">
          <template #default="scoped">
            <el-select v-model="scoped.row.type" placeholder="请选择" :disabled="scoped.row.is_sys">
              <div v-if="scoped.$index == 0">
                <el-option v-for="item in TYPE_STATUS_DELETE_ALL" :key="item.value" :label="item.label" :value="item.value"> </el-option>
              </div>
              <div v-else>
                <el-option v-for="item in TYPE_STATUS_LAST" :key="item.value" :label="item.label" :value="item.value"> </el-option>
              </div>
            </el-select>
          </template>
        </el-table-column>
        <el-table-column prop="address" label="指派给" width="150">
          <template #default="scoped">
            <el-select :disabled="scoped.row.is_sys" v-model="scoped.row.staff_name" filterable placeholder="请选择">
              <div v-if="scoped.$index == 0">
                <el-option v-for="item in employeeLists" :key="item.staff_no" :label="item.staff_name" :value="item.staff_name"> </el-option>
              </div>
              <div v-else>
                <el-option v-for="item in employeeLists_last" :key="item.staff_no" :label="item.staff_name" :value="item.staff_name"> </el-option>
              </div>
            </el-select>
          </template>
        </el-table-column>
        <el-table-column prop="address" label="起止时间" width="400">
          <template #default="scoped">
            <el-date-picker
              :disabled="scoped.row.is_sys"
              v-model="scoped.row.time"
              type="daterange"
              range-separator="至"
              start-placeholder="开始日期"
              end-placeholder="结束日期"
              value-format="YYYY-MM-DD"
            >
            </el-date-picker>
          </template>
        </el-table-column>
        <el-table-column prop="name" label="工时" width="130">
          <template #default="scoped">
            <el-input placeholder="请输入工时" :disabled="scoped.row.is_sys" v-model.number="scoped.row.hours" maxlength="10"></el-input>
          </template>
        </el-table-column>
        <!-- <el-table-column prop="address" label="关联计划" width="150">
          <template #default="scoped">
            <el-select v-model="scoped.row.id" placeholder="请选择">
              <div v-if="scoped.$index == 0">
                <el-option v-for="item in planLists" :key="item.plan.id" :label="item.plan.name" :value="item.plan.id"> </el-option>
              </div>
              <div v-else>
                <el-option v-for="item in planLists_last" :key="item.plan.id" :label="item.plan.name" :value="item.plan.id"> </el-option>
              </div>
            </el-select>
          </template>
        </el-table-column> -->
        <el-table-column prop="name" label="备注">
          <template #default="scoped">
            <el-input v-model="scoped.row.remark"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="120" v-if="!isEdit">
          <template #default="scoped">
            <i class="el-icon-circle-plus-outline action" @click="handlePlusTable"></i>
            <el-divider direction="vertical"></el-divider>
            <i class="el-icon-remove-outline action" v-if="scoped.$index !== 0" @click="handleRemoveTable(scoped.$index)"></i>
          </template>
        </el-table-column>
      </el-table>
    </div>
  </div>
</template>

<script lang="ts">
import { defineComponent, reactive, computed, ref } from "vue";
import { getSession, TYPE_STATUS } from "@/utils";
import { useStore } from "@/store";
import { createTaskList, updateTask } from "@/api/request-modules/iteration";
import { getPlanLists } from "@/api/request-modules/plan";

import { ResponseParams } from "@/types/response";
import useMessageTip from "@/composables/useMessageTip";
import { useRoute, useRouter } from "vue-router";
import useMixin from "../useMixin";
export default defineComponent({
  setup() {
    const router = useRouter();
    const route = useRoute();
    const isEdit = ref(false);
    const rawTableData = {
      // 任务名称
      name: "",
      // 指派给
      staff_name: "",
      staff_no: "",
      // 类型
      type: "",
      time: [],
      // // 开始时间
      // real_begin_time: "",
      // // 结束时间
      // real_end_time: "",
      // 工时
      hours: "",
      // 需求id
      iteration_id: "",
      // 备注
      remark: ""
    };
    const tableData = reactive(
      Array(route.query.isEdit ? 1 : 10)
        .fill({})
        .map(() => {
          return { ...rawTableData };
        })
    );

    if (route.query.isEdit) {
      const userInfo = getSession("editTask", true) as any;
      isEdit.value = true;
      tableData[0] = userInfo;
      (tableData[0].time as Array<string>) = [userInfo.begin_time, userInfo.end_time] as Array<string>;
    } else {
      // 填充数据处理，将类型，指派给默认设置为同上
      tableData.forEach((v, index) => {
        if (index >= 1) {
          v.staff_no = "500";
          v.type = v.staff_name = "同上";
        }
      });
    }
    const planLists = ref([]);
    const { tipMessage } = useMessageTip();
    const planLists_last = ref<Record<string, any>>([]);
    const employeeLists = computed(() => useStore() && useStore().getters.employeeLists);
    const employeeLists_last = computed(() => [{ staff_name: "同上", value: 500 }].concat(employeeLists.value));
    const TYPE_STATUS_DELETE_ALL = TYPE_STATUS.slice().splice(1, TYPE_STATUS.length);
    const TYPE_STATUS_LAST = [{ label: "同上", value: 500 }].concat(TYPE_STATUS_DELETE_ALL.slice());
    const { searchParams } = useMixin();
    getPlanLists<ResponseParams.ResponseDataSuccess>().then((res) => {
      planLists.value = res.data;
      planLists_last.value = [{ plan: { id: 500, name: "同上" } }].concat(res.data);
    });

    const handlePlusTable = () => {
      tableData.push({ ...rawTableData });
    };
    const handleRemoveTable = (item: number) => {
      if (tableData.length <= 1) {
        return;
      }
      tableData.splice(item, 1);
    };
    const handleConfirmSave = () => {
      const post_table = JSON.parse(JSON.stringify(tableData));
      const resultTable = post_table.filter((v: Record<string, any>) => v.name !== "");

      resultTable.forEach((itemObj: Record<string, any>, index: number) => {
        for (let key in itemObj) {
          if (itemObj[key] === 500 || itemObj[key] === "同上") {
            itemObj[key] = resultTable[index - 1][key as keyof typeof rawTableData];
          }
          if (key === "staff_name" && itemObj[key] && itemObj[key] !== "所有人") {
            const staff_no = employeeLists.value.find((employee: Record<string, any>) => employee.staff_name === itemObj[key]).staff_no;
            resultTable[index].staff_no = staff_no;
          }
        }
        if (itemObj.type === "") {
          tipMessage(400, `请选择第${index + 1}条的类型`);
          throw new Error("未选择类型！");
        }
        if (itemObj.staff_name === "" || itemObj.staff_no === "") {
          tipMessage(400, `请选择第${index + 1}条的指派人`);
          throw new Error("未选择指派人！");
        }
        if (itemObj.time.length) {
          itemObj.begin_time = itemObj.time[0];
          itemObj.end_time = itemObj.time[1];
        } else {
          tipMessage(400, `请选择第${index + 1}条的起止时间`);
          throw new Error("未选择起止时间！");
        }
        delete itemObj.time;
        if (itemObj.hours === "" || !itemObj.hours.toString().match(/\d/g)) {
          tipMessage(400, `请输入正确第${index + 1}条的工时`);
          throw new Error("工时错误！");
        }
        itemObj.iteration_id = searchParams.demand;
      });
      if (resultTable.length) {
        if (isEdit.value) {
          updateTask<ResponseParams.ResponseDataSuccess>(resultTable[0]).then((res) => {
            successCallBack(res.code);
          });
        } else {
          createTaskList<ResponseParams.ResponseDataSuccess>(resultTable).then((res) => {
            successCallBack(res.code);
          });
        }
      } else {
        router.go(-1);
      }

      const successCallBack = (code: number) => {
        tipMessage(code);
        if (code === 200) {
          router.go(-1);
        }
      };
    };
    return {
      handleConfirmSave,
      TYPE_STATUS_DELETE_ALL,
      TYPE_STATUS_LAST,
      employeeLists,
      employeeLists_last,
      planLists,
      planLists_last,
      handleRemoveTable,
      handlePlusTable,
      tableData,
      isEdit
    };
  }
});
</script>

<style scoped>
.action {
  font-size: 20px;
  cursor: pointer;
}
</style>
